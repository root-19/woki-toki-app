<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Group Voice Chat</title>
    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="entry-modal" class="flex items-center justify-center h-screen bg-gray-800 text-white">
        <div class="text-center">
            <h1 class="text-3xl font-bold mb-4">Join Voice Chat</h1>
            <input id="room-id" class="p-2 rounded text-gray-800" type="text" placeholder="Enter Room ID" />
            <button id="join-btn" class="px-4 py-2 bg-blue-500 rounded text-white mt-4">Join</button>
        </div>
    </div>

    <div id="meet-area" class="hidden h-screen flex flex-col">
        <div class="flex justify-between p-4 bg-blue-600 text-white">
            <h2 class="text-xl font-bold">Voice Chat Room</h2>
            <span id="room-id-display"></span>
        </div>
        <div class="flex-grow p-4">
            <div id="user-icons" class="flex flex-wrap gap-4"></div>
        </div>
        <div class="p-4 bg-gray-200 text-center">
            <audio id="local-audio" controls autoplay muted></audio>
        </div>
    </div>

    <script>
        const peersList = new Set(); // Keep track of all connected peer IDs
        const connections = [];
        let localStream = null;
        let peer = null;
        let roomId = "";

        document.getElementById("join-btn").addEventListener("click", () => {
            roomId = document.getElementById("room-id").value.trim();
            if (roomId) {
                joinRoom();
                document.getElementById("room-id-display").innerText = `Room ID: ${roomId}`;
            }
        });

        function joinRoom() {
            document.getElementById("entry-modal").classList.add("hidden");
            document.getElementById("meet-area").classList.remove("hidden");

            peer = new Peer();

            peer.on("open", (id) => {
                console.log("Connected with ID:", id);
                peersList.add(id); // Add local user ID to the list
                addUserIcon(id); // Show local user in UI

                navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
                    localStream = stream;

                    const localAudio = document.getElementById("local-audio");
                    localAudio.srcObject = localStream;
                    localAudio.play();

                    notify("Connected to the room.");

                    // Notify others that a new user has joined
                    const conn = peer.connect(roomId);
                    conn.on("open", () => {
                        conn.send({ type: "join", id: id });
                    });

                    // Call existing peers
                    peersList.forEach((peerId) => {
                        if (peerId !== id) {
                            const call = peer.call(peerId, localStream);
                            call.on("stream", (remoteStream) => {
                                addRemoteAudio(remoteStream, call.peer);
                            });
                            connections.push(call);
                        }
                    });

                    // Listen for new connections
                    peer.on("connection", (conn) => {
                        conn.on("data", (data) => {
                            if (data.type === "join" && !peersList.has(data.id)) {
                                peersList.add(data.id);
                                addUserIcon(data.id);

                                // Notify the new user of all current users
                                conn.send({ type: "current-users", users: Array.from(peersList) });
                                
                                // Call the newly joined peer
                                const call = peer.call(data.id, localStream);
                                call.on("stream", (remoteStream) => {
                                    addRemoteAudio(remoteStream, call.peer);
                                });
                                connections.push(call);
                            } else if (data.type === "current-users") {
                                // Add all current users sent by the new user
                                data.users.forEach((userId) => {
                                    if (!peersList.has(userId)) {
                                        peersList.add(userId);
                                        addUserIcon(userId);
                                    }
                                });
                            }
                        });
                    });

                    // Listen for incoming calls
                    peer.on("call", (call) => {
                        call.answer(localStream); // Send your stream to the caller
                        call.on("stream", (remoteStream) => {
                            addRemoteAudio(remoteStream, call.peer); // Play the remote stream
                        });
                        connections.push(call);
                    });
                }).catch((err) => {
                    console.error("Error accessing audio devices:", err);
                });
            });
        }

        function addUserIcon(peerId) {
            const userIcons = document.getElementById("user-icons");
            if (document.getElementById(`user-${peerId}`)) return; // Avoid duplicate icons

            const userDiv = document.createElement("div");
            userDiv.id = `user-${peerId}`;
            userDiv.className = "p-4 bg-blue-500 text-white rounded shadow";
            userDiv.innerText = `User: ${peerId}`;
            userIcons.appendChild(userDiv);
        }

        function addRemoteAudio(stream, peerId) {
            const existingAudio = document.getElementById(`audio-${peerId}`);
            if (existingAudio) return;

            const audio = document.createElement("audio");
            audio.id = `audio-${peerId}`;
            audio.srcObject = stream;
            audio.autoplay = true;

            document.body.appendChild(audio);
        }

        function notify(message) {
            console.log(message);
        }
    </script>
</body>
</html>
